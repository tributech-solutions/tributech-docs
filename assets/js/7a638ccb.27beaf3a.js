"use strict";(self.webpackChunktributech_docs=self.webpackChunktributech_docs||[]).push([[8502],{49739:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return c},default:function(){return h},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return m}});var a=n(83117),o=n(80102),r=(n(67294),n(3905)),i=n(36110),s=["components"],l={title:"MQTT Source",sidebar_position:1},c=void 0,u={unversionedId:"tributech_agent/sources/mqtt_source",id:"version-3.6.0/tributech_agent/sources/mqtt_source",title:"MQTT Source",description:"The Tributech Agent supports the integration of external data sources using the MQTT messaging protocol with the  Tributech MQTT Source. The MQTT Source itself is configured via the Twin Configuration and will be described in the following sections.",source:"@site/versioned_docs/version-3.6.0/tributech_agent/sources/mqtt_source.mdx",sourceDirName:"tributech_agent/sources",slug:"/tributech_agent/sources/mqtt_source",permalink:"/tributech_agent/sources/mqtt_source",draft:!1,editUrl:"https://github.com/tributech-solutions/tributech-dsk-docs/edit/master/versioned_docs/version-3.6.0/tributech_agent/sources/mqtt_source.mdx",tags:[],version:"3.6.0",sidebarPosition:1,frontMatter:{title:"MQTT Source",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Source Integration",permalink:"/tributech_agent/source_integration"},next:{title:"ADS Source",permalink:"/tributech_agent/sources/ads_source"}},p={},m=[{value:"Setup",id:"setup",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Value Change Options",id:"value-change-options",level:3},{value:"Providing Data",id:"providing-data",level:2},{value:"MQTT Explorer",id:"mqtt-explorer",level:3},{value:"MockClient",id:"mockclient",level:3},{value:"Modify docker-compose.override.yml",id:"modify-docker-composeoverrideyml",level:4}],d={toc:m};function h(e){var t=e.components,l=(0,o.Z)(e,s);return(0,r.kt)("wrapper",(0,a.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The Tributech Agent supports the integration of external data sources using the ",(0,r.kt)("a",{parentName:"p",href:"https://mqtt.org/"},(0,r.kt)("strong",{parentName:"a"},"MQTT messaging protocol"))," with the  Tributech MQTT Source. The MQTT Source itself is configured via the Twin Configuration and will be described in the following sections."),(0,r.kt)("h2",{id:"setup"},"Setup"),(0,r.kt)("p",null,"The Tributech MQTT Source image can be started without any dependencies but will not be functional without a valid Twin Configuration or MessageBroker connect to the Tributech Agent. The TwinConfiguration can be provided via the Tributech Node (recommended) or MessageBroker (see ",(0,r.kt)("a",{parentName:"p",href:"../source_integration#twin-model"},"Source Integration"),"). The MQTT Source will automatically connect to the Tributech Agent if the Tributech Agent is running and the MQTT Source is configured with the correct MessageBroker settings."),(0,r.kt)("p",null,"In the following part we will describe the setup of a Tributech MQTT Source."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Setup the ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"docker environment"))," by creating a ",(0,r.kt)("inlineCode",{parentName:"li"},".env")," file with the following content and replace the placeholder values with your values:")),(0,r.kt)(i.Z,{className:"language-plain",title:".env",mdxType:"CodeBlock"},"AGENT_TAG=3.6.0\nAGENT_ID=00000000-0000-0000-0000-000000000007\nSOURCE_TAG=3.6.0\n"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Setup the ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"docker-compose.yml"))," file by creating a ",(0,r.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," file with the following content in the same folder as the  ",(0,r.kt)("inlineCode",{parentName:"li"},".env")," file:")),(0,r.kt)(i.Z,{className:"language-yml",title:"docker-compose.yml",mdxType:"CodeBlock"},'version: "3.6"\n\nservices:\n  source-mqtt:\n    image: ${DOCKER_REGISTRY-tributech.azurecr.io/}tributech-source-mqtt:${SOURCE_TAG:-latest}\n    depends_on:\n      - mosquitto-server-mqtt\n      - tributech-agent-mqtt\n    environment:\n      - MqttOptions__MQTTHost=mosquitto-server-mqtt\n      - Logging__LogLevel__Default=Debug\n    networks:\n      - mqtt-net\n    restart: unless-stopped\n    logging:\n      driver: "json-file"\n      options:\n        max-size: "2m"\n        max-file: "5"\n\n  tributech-agent-mqtt:\n    image: ${DOCKER_REGISTRY-tributech.azurecr.io/}tributech-agent:${AGENT_TAG:-latest}\n    depends_on:\n      - mosquitto-server-mqtt\n    environment:\n      - Logging__LogLevel__Default=Debug\n      - Logging__Console__FormatterName=simple\n      - MqttOptions__MQTTHost=mosquitto-server-mqtt\n      # general DSK edge agent configuration\n      - EdgeDeviceOptions__AgentID=${AGENT_ID:?"The variable AGENT_ID needs to be configured in the .env file."}\n    networks:\n      - mqtt-net\n    ports:\n      - "5000:80" # enable access to agent mqtt-API (e.g. for configuration with Agent-Companion)\n    volumes:\n      - ./volumes/mqtt/agent/:/app/data # volume mapping for permanent storage of keys and datatwin file\n    restart: unless-stopped\n    logging:\n      driver: "json-file"\n      options:\n        max-size: "2m"\n        max-file: "5"\n\n  mosquitto-server-mqtt:\n    image: eclipse-mosquitto:${MQTT_TAG:-1.6}\n    networks:\n      - mqtt-net\n    ports:\n     - \'1883:1883\' # MQTT\n    # - "127.0.0.1:9001:9001" # web-socket\n    restart: unless-stopped\n\n\nnetworks:\n  mqtt-net:\n'),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"After setting up the Tributech MQTT Source we need to link it to the Tributech Node (see ",(0,r.kt)("a",{parentName:"p",href:"/tributech_agent/quickstart#link-agent"},"QuickStart"),") and configure the TwinConfiguration."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**&quot;Configure Agent**",src:n(62726).Z,width:"1909",height:"351"})),(0,r.kt)("p",null,"We can now add by right clicking the Device Edge entry a new MQTT Source."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**&quot;Add MQTT Source**",src:n(55760).Z,width:"711",height:"587"})),(0,r.kt)("p",null,"After right clicking on the MQTT Source entry we can add a new MQTT Stream."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**&quot;Add MQTT Stream**",src:n(3911).Z,width:"1161",height:"599"})),(0,r.kt)("p",null,"We can now adjust the stream to our requirements. The following example shows how to setup a stream for a double value with the display name MQTT Stream and the MQTT Topic ",(0,r.kt)("inlineCode",{parentName:"p"},"test/#"),". For custom topics, two wildcards are supported:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A '#' character represents a complete sub-tree of the hierarchy and thus must be the last character in a subscription topic string, such as test/#. This will match any topic starting with test/, such as test/1/TEMP and test/2/HUMIDITY."),(0,r.kt)("li",{parentName:"ul"},"A '+' character represents a single level of the hierarchy and is used between delimiters. For example, test/+/TEMP will match test/1/TEMP and test/2/TEMP.")),(0,r.kt)("p",null,"We can save the settings by clicking on the ",(0,r.kt)("inlineCode",{parentName:"p"},"SAVE IN WORKSPACE")," button in the bottom right corner."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**&quot;Add MQTT Stream**",src:n(67518).Z,width:"2553",height:"1119"})),(0,r.kt)("p",null,"We can repeat this process for all required streams for the MQTT Source. An important note is that the MQTT Source will only work when there are no overlapping topics, i.e. ",(0,r.kt)("inlineCode",{parentName:"p"},"test/#")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"test/+/TEMP")," are not allowed to be configured for the same MQTT Source.\nAfter we have configured the MQTT Source we can apply the configuration to the Tributech Agent by clicking on the ",(0,r.kt)("inlineCode",{parentName:"p"},"APPLY CONFIGURATION")," button in the top right corner."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**&quot;Add MQTT Stream**",src:n(72477).Z,width:"2556",height:"406"})),(0,r.kt)("p",null,"This completes the configuration of the MQTT Source and we can now send data to the MQTT Source either via an MQTT Client Application like ",(0,r.kt)("a",{parentName:"p",href:"https://mqttx.app/"},"MQTTX"),", ",(0,r.kt)("a",{parentName:"p",href:"http://mqtt-explorer.com/"},"MQTT Explorer")," or with our ",(0,r.kt)("a",{parentName:"p",href:"#mockclient"},"Tributech MQTT MockClient"),". The Tributech MQTT Source MockClient is currently only for testing purposes and works only in combination with our Tributech MQTT Source."),(0,r.kt)("h3",{id:"value-change-options"},"Value Change Options"),(0,r.kt)("p",null,"The basic handling of Value Change Options (VCO) can be found in ",(0,r.kt)("a",{parentName:"p",href:"/tributech_agent/source_integration#value-change-options"},"Source Integration"),". This section contains the concrete handling of the ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Step (Delta)"))," for the simulated source. The following list contains the description for each supported ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Stream Data Encoding"))," where ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"X"))," represents the value for ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Step (Delta)")),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"Double")),", ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"Int32")),", ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"Long")),", ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"Float")),": defines the minimum difference between values to be submitted, the change is always compared to the last successful submitted value, e.g. if ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"X")),"= 3 if the double values 1, 2, 5, 8, 10, 11, 14 are received by the Tributech Source only 1, 5, 8, 11, 14 will be submitted."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"Byte Array")),": will only be submitted if the current and last submitted value are not equal"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"String UTF 8")),": will only be submitted if the current and last submitted value are not equal"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("em",{parentName:"strong"},"Boolean")),": will only be submitted if the current and last submitted value are not equal")),(0,r.kt)("h2",{id:"providing-data"},"Providing Data"),(0,r.kt)("p",null,"In the following section we want to outline two different ways to provide data to the MQTT Source. The first way is to use the ",(0,r.kt)("a",{parentName:"p",href:"http://mqtt-explorer.com/"},(0,r.kt)("strong",{parentName:"a"},"MQTT Explorer"))," to send data to the MQTT Source. The second way is to use the MQTT MockClient to send data to the MQTT Source. In our example we can access the MQTT MessageBroker on port 1833 (need to match your ",(0,r.kt)("inlineCode",{parentName:"p"},"mosquitto-server-mqtt")," service in the ",(0,r.kt)("a",{target:"_blank",href:n(80722).Z},(0,r.kt)("code",null,"docker-compose.yml")),")."),(0,r.kt)("h3",{id:"mqtt-explorer"},"MQTT Explorer"),(0,r.kt)("p",null,"With the ",(0,r.kt)("a",{parentName:"p",href:"http://mqtt-explorer.com/"},(0,r.kt)("strong",{parentName:"a"},"MQTT Explorer"))," we can directly send json payload to a specific topic. The MQTT Explorer can connect to the MessageBroker on port 1833 (need to match your ",(0,r.kt)("inlineCode",{parentName:"p"},"mosquitto-server-mqtt")," service in the ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),"). The example will submit the following payload data to the MQTT Source previously configured in ",(0,r.kt)("a",{parentName:"p",href:"#Setup"},"Setup")," :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'    {\n        "Timestamp":"2023-07-13T05:50:07.1003104+00:00",\n        "Value":"530zo/N+jsA="\n    }\n')),(0,r.kt)("p",null,"We can post the data to the MQTT Source by clicking on the ",(0,r.kt)("inlineCode",{parentName:"p"},"Publish")," button in the top right corner."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**Mqtt Explorer publish**",src:n(41093).Z,width:"1453",height:"558"})),(0,r.kt)("p",null,"The MQTT Source will now receive the data, process it and send it to the Tributech Agent. The Tributech Agent will forward the data to the Tributech Node where with can inspect the values. We can follow this data flow on the left hand side of the MQTT Explorer by observing which topics receive data, i.e. ",(0,r.kt)("inlineCode",{parentName:"p"},"edge/{agent-id}/value/ValueSource")," is our Tributech Agent.\nThe data can be viewed in the Tributech Node by clicking on the ",(0,r.kt)("inlineCode",{parentName:"p"},"MQTT Stream"),"."),(0,r.kt)("p",null,"Per default we will show directly the ",(0,r.kt)("inlineCode",{parentName:"p"},"Stream Data Encoding")," datatype tab with the timestamp and value.\n",(0,r.kt)("img",{alt:"**Mqtt Explorer publish**",src:n(17182).Z,width:"1720",height:"541"})),(0,r.kt)("p",null," We can switch to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Byte Array")," tab to see the data we have submitted.\nThe value and timestamp (in UTC) are displayed and match our submitted data."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**Mqtt Explorer publish**",src:n(1470).Z,width:"1729",height:"546"})),(0,r.kt)("h3",{id:"mockclient"},"MockClient"),(0,r.kt)("p",null,"We provide an additional ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.override.yml")," below to include a MockClient. This setup can be used to send data to the MQTT Source without external tools. The MockClient is only for testing purposes and should not be used in production. In order to start the the MockClient with the Tributech MQTT Source copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.override.yml")," file in the same folder as the ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," before using the ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose up")," command. The following configuration shows how to setup the MockClient and send data to the MQTT Source for a stream double stream. The Custom-Topic needs to be inserted into the ",(0,r.kt)("inlineCode",{parentName:"p"},"<custom-topic>")," placeholder, e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"test/foo"),":"),(0,r.kt)(i.Z,{className:"language-yml",title:"docker-compose.override.yml",mdxType:"CodeBlock"},'version: "3.6"\n\nservices:\n  source-mqtt-mock-client:\n    image: ${DOCKER_REGISTRY-tributech.azurecr.io/}tributech-source-mqtt-mockclient:${SOURCE_TAG:-latest}\n    depends_on:\n      - mosquitto-server-mqtt\n      - tributech-agent-mqtt\n      - source-mqtt\n    environment:\n      - MqttOptions__MQTTHost=mosquitto-server-mqtt\n      - Logging__LogLevel__Default=Debug\n      - MockOptions__Streams__0__Topic=test/bar\n      - MockOptions__Streams__0__StreamEncoding=3 # double\n      - MockOptions__Streams__0__Interval=00:00:05.000\n    networks:\n      - mqtt-net\n    restart: unless-stopped\n'),(0,r.kt)("p",null,"After starting the MockClient we need to apply the configuration again from the Tributech Node to our Tributech MQTT Source. For this we need to go back to the Source configuration window in the Tributech Node and click on the ",(0,r.kt)("inlineCode",{parentName:"p"},"APPLY CONFIGURATION")," button again. Then we can see the data in the Tributech Node. The following example shows the data for the double stream."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"**MQTT Mock publish**",src:n(59895).Z,width:"1703",height:"891"})),(0,r.kt)("h4",{id:"modify-docker-composeoverrideyml"},"Modify docker-compose.override.yml"),(0,r.kt)("p",null,"We can adjust the data generation to our needs by modifying the ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose.override.yml")," file, see ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/compose/"},"Docker")," for details on how to setup the environment for docker-compose."),(0,r.kt)("p",null,"We can send different datatypes to specified streams and modify the following ",(0,r.kt)("inlineCode",{parentName:"p"},"environment")," variables to change the stream generation behaviour:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"StreamEncoding"),": Sets the datatype which will be generated based on a numeric value:"),(0,r.kt)("table",{parentName:"li"},(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Value"),(0,r.kt)("th",{parentName:"tr",align:null},"Datatype"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"byte-array")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"float")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"double")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4"),(0,r.kt)("td",{parentName:"tr",align:null},"int")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"long")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"6"),(0,r.kt)("td",{parentName:"tr",align:null},"string_utf8")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"8"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Interval"),": The interval (default 10sec) in which the values are generated in TimeSpan format, e.g. 00:00:05 for 5 seconds, see ",(0,r.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/dotnet/standard/base-types/standard-timespan-format-strings"},"Microsoft")," for details on TimeSpan format")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"MinValue")," (default -1000): The minimum value that can be generated (for bytearrays and string this is the length of the array/string, default 1)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"MaxValue")," (default 1000): The max value that can be generated (for bytearrays and string this is the length of the array/string)"))),(0,r.kt)("p",null,"In Order to add more streams the environment ",(0,r.kt)("inlineCode",{parentName:"p"},"MockOptions")," setting can be adjusted based on the AppSettings.json configuration capabilities, see ",(0,r.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-7.0"},"Microsoft")," for details on how to setup the environment variables. The following setup shows how to add a second stream float stream to the MockClient:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"    ...\n    environment:\n      ...\n      # Stream 1\n      - MockOptions__Streams__0__Topic=xxo/foo\n      - MockOptions__Streams__0__StreamEncoding=3 # double\n\n      # Stream 2\n      - MockOptions__Streams__0__Topic=xxo/foo\n      - MockOptions__Streams__0__StreamEncoding=2 # float\n      ...\n")))}h.isMDXComponent=!0},80722:function(e,t,n){t.Z=n.p+"assets/files/docker-compose-b3f1583682014f5266db66d7f60926ec.yml"},62726:function(e,t,n){t.Z=n.p+"assets/images/node-agent-configure-7ae7cf405f48c53a50f626b64ce56f49.png"},3911:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-add-stream-72e9b38539a9c5a9b3675c313997d9e9.png"},55760:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-add-e97d86f1c70ab2d4c883c37419b7c9bd.png"},72477:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-apply-config-16361f3cc5e4ef2e48f68e83128cc22c.png"},67518:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-config-stream-694891d8b325b3ffee059e89e438104e.png"},1470:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-stream-value-bytearray-194eccd3686342fdb83825158a24a2bf.png"},17182:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-stream-value-double-05c0f7d575db33e1b3e170cbbd727897.png"},41093:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-stream-value-publish-ce3aa103b21409608dacce5ca40418c7.png"},59895:function(e,t,n){t.Z=n.p+"assets/images/node-source-mqtt-stream-values-mock-99f9ae128dda66dbdad3fc994fc52ea2.png"}}]);